@{
    ViewBag.Title = "Servicio Registrar Auto";
}

<h2>1. Servicio Registrar Auto</h2>

<div class="row mt-4">
    <!-- Formulario (Izquierda) -->
    <div class="col-md-5">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">
                    <i class="bi bi-plus-circle"></i> Nuevo Vehículo
                </h5>
                <form id="form-auto">
                    <div class="mb-3">
                        <label for="placa" class="form-label">Placa (Patente)</label>
                        <input type="text" class="form-control" id="placa" placeholder="ABC-123" maxlength="50" required />
                    </div>
                    <div class="mb-3">
                        <label for="marca" class="form-label">Marca</label>
                        <input type="text" class="form-control" id="marca" placeholder="Toyota" maxlength="100" required />
                    </div>
                    <div class="mb-3">
                        <label for="modelo" class="form-label">Modelo</label>
                        <input type="text" class="form-control" id="modelo" placeholder="Corolla" maxlength="100" />
                    </div>
                    <div class="mb-3">
                        <label for="ano" class="form-label">Año</label>
                        <input type="number" class="form-control" id="ano" placeholder="2025" min="1900" max="2100" />
                    </div>
                    <div class="mb-3">
                        <label for="propietario" class="form-label">Propietario</label>
                        <input type="text" class="form-control" id="propietario" placeholder="Juan Pérez" maxlength="100" />
                    </div>
                    <button type="submit" class="btn btn-primary w-100">Registrar Vehículo</button>
                </form>

                <div id="mensaje-auto" class="mt-3 d-none"></div>
            </div>
        </div>
    </div>

    <!-- Tabla de vehículos (Derecha) -->
    <div class="col-md-7">
        <div class="card">
            <div class="card-body">
                <h5 class="card-title">Vehículos Registrados</h5>
                <div class="table-responsive">
                    <table class="table table-striped table-hover" id="tabla-autos">
                        <thead class="table-light">
                            <tr>
                                <th>Placa</th>
                                <th>Vehículo</th>
                                <th>Año</th>
                                <th>Propietario</th>
                            </tr>
                        </thead>
                        <tbody id="tbody-autos">
                            <tr>
                                <td colspan="4" class="text-center text-muted">Cargando vehículos...</td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section scripts {
    <script type="text/javascript">
        $(function () {
            // Cargar autos al iniciar
            cargarAutos();

            // Registrar nuevo auto
            $("#form-auto").on("submit", function (e) {
                e.preventDefault();

                var datos = {
                    placa: $("#placa").val(),
                    marca: $("#marca").val(),
                    modelo: $("#modelo").val(),
                    ano: $("#ano").val() ? parseInt($("#ano").val(), 10) : null,
                    propietario: $("#propietario").val()
                };

                $("#mensaje-auto").removeClass("alert alert-success alert-danger").addClass("d-none");

                $.ajax({
                    url: '@Url.Content("~/api/autos")',
                    method: 'POST',
                    contentType: 'application/json; charset=utf-8',
                    data: JSON.stringify(datos),
                    success: function (respuesta) {
                        $("#mensaje-auto")
                            .removeClass("d-none")
                            .addClass("alert alert-success")
                            .text("Vehículo registrado correctamente. ID: " + respuesta.idAuto);

                        $("#form-auto")[0].reset();
                        cargarAutos(); // Recargar tabla
                    },
                    error: function (xhr) {
                        var mensaje = 'Error al registrar el vehículo.';
                        if (xhr.responseJSON && xhr.responseJSON.Message) {
                            mensaje = xhr.responseJSON.Message;
                        }

                        $("#mensaje-auto")
                            .removeClass("d-none")
                            .addClass("alert alert-danger")
                            .text(mensaje);
                    }
                });
            });

            // Función para cargar autos
            function cargarAutos() {
                $.ajax({
                    url: '@Url.Content("~/api/autos")',
                    method: 'GET',
                    contentType: 'application/json; charset=utf-8',
                    success: function (autos) {
                        var tbody = $("#tbody-autos");
                        tbody.empty();

                        if (autos.length === 0) {
                            tbody.append('<tr><td colspan="4" class="text-center text-muted">No hay vehículos registrados</td></tr>');
                        } else {
                            $.each(autos, function (index, auto) {
                                var marca = auto.marca || '';
                                var modelo = auto.modelo ? ' ' + auto.modelo : '';
                                var vehiculo = marca + modelo;
                                var ano = auto.ano || '-';
                                var propietario = auto.propietario || '-';

                                var fila = '<tr>' +
                                    '<td>' + auto.placa + '</td>' +
                                    '<td>' + vehiculo + '</td>' +
                                    '<td>' + ano + '</td>' +
                                    '<td>' + propietario + '</td>' +
                                    '</tr>';

                                tbody.append(fila);
                            });
                        }
                    },
                    error: function () {
                        $("#tbody-autos").empty();
                        $("#tbody-autos").append('<tr><td colspan="4" class="text-center text-danger">Error al cargar vehículos</td></tr>');
                    }
                });
            }
        });
    </script>
}
